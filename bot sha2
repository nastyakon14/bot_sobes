# -*- coding: utf-8 -*-
"""Копия блокнота "конечный вариант"

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1tfY-1TSo6_JLwEyIui7nVLlXES7bjEwv
"""

from flask import Flask, request, json

import vk_api
import random
import datetime as dt
import re
import traceback
import time
import gspread   # для работы с гугл шитс
from google.oauth2.service_account import Credentials

scopes = [
'https://www.googleapis.com/auth/spreadsheets',
'https://www.googleapis.com/auth/drive'
]

credentials = Credentials.from_service_account_file('bot-sha2-94a5230fc5f9.json',scopes=scopes)

# gc = gspread.authorize(credentials)
# Указываем путь к JSON (если версия gspread >= 3.6):
gc = gspread.service_account(filename='bot-sha2-94a5230fc5f9.json')

#Открываем таблицу
sh = gc.open("Собеседования ША2 | 2023")
# sh = gc.open("1skC-YAXS7WBgDqSng9Ufi3s_FDBxgs-UT245tjTk5Yk")
from vk_api.keyboard import VkKeyboard, VkKeyboardColor

vk = vk_api.VkApi(token="vk1.a.U1aXutliTlQzbvkV09MyPPbiuCByAa_ipxaS7BzVKD9GNkbSWAFzLnR5Jzaleu1xw4QX73FJ30RYY9FA2d0KECMxdHpJpCUDExKyQNP5wWRrWMCdzOSoTFetdxJGuXULsAzZXclCOXUl8T8KNfEAXm9CvAE7wkKnUZPcwj489dRo2P8GrMrGsxuQWupZpyaEnnDl_TkcA_mYKCX6hEyfaQ")
application = Flask(__name__)

with open('slots.json','r',encoding="utf-8") as read_file:
  slots = json.load(read_file)
read_file.close()

keyboard = VkKeyboard(one_time = False)
keyboard.add_button('Записаться на собеседование', color = VkKeyboardColor.POSITIVE)
keyboard.add_line()
keyboard.add_button('Отменить запись', color = VkKeyboardColor.NEGATIVE)
keyboard.get_keyboard()

keyboard_date = VkKeyboard(one_time = False)     # даты
keyboard_date.add_button("1.03", color = VkKeyboardColor.PRIMARY)
keyboard_date.add_button("2.03", color = VkKeyboardColor.PRIMARY)
keyboard_date.add_button("3.03", color = VkKeyboardColor.PRIMARY)
keyboard_date.add_button("4.03", color = VkKeyboardColor.PRIMARY)
keyboard_date.add_line()
keyboard_date.add_button("5.03", color = VkKeyboardColor.PRIMARY)
keyboard_date.add_button("6.03", color = VkKeyboardColor.PRIMARY)
keyboard_date.add_button("7.03", color = VkKeyboardColor.PRIMARY)
keyboard_date.add_button("8.03", color = VkKeyboardColor.PRIMARY)
keyboard_date.add_line()
keyboard_date.add_button('Вернуться назад', color = VkKeyboardColor.NEGATIVE)
keyboard_date.get_keyboard()


days = []    # все временные слоты по дням
for i in slots.values():
    days.append(i)
    
    
days1 = sorted(set(days[0])) 
keyboard_time1 = VkKeyboard()
for i in range(len(days1)):
  if (i+1) %3 != 0:
    keyboard_time1.add_button(days1[i], color = VkKeyboardColor.SECONDARY)
  else:
    keyboard_time1.add_line()
    keyboard_time1.add_button(days1[i], color = VkKeyboardColor.SECONDARY)

keyboard_time1.add_line()
keyboard_time1.add_button('Назад', color = VkKeyboardColor.NEGATIVE)
keyboard_time1.get_keyboard()


days2 = sorted(set(days[1])) 
keyboard_time2 = VkKeyboard()
for i in range(len(days2)):
  if (i+1) %3 != 0:
    keyboard_time2.add_button(days2[i], color = VkKeyboardColor.SECONDARY)
  else:
    keyboard_time2.add_line()
    keyboard_time2.add_button(days2[i], color = VkKeyboardColor.SECONDARY)

keyboard_time2.add_line()
keyboard_time2.add_button('Назад', color = VkKeyboardColor.NEGATIVE)
keyboard_time2.get_keyboard()



days3 = sorted(set(days[2])) 
keyboard_time3 = VkKeyboard()
for i in range(len(days3)):
  if (i+1) %3 != 0:
    keyboard_time3.add_button(days3[i], color = VkKeyboardColor.SECONDARY)
  else:
    keyboard_time3.add_line()
    keyboard_time3.add_button(days3[i], color = VkKeyboardColor.SECONDARY)

keyboard_time3.add_line()
keyboard_time3.add_button('Назад', color = VkKeyboardColor.NEGATIVE)
keyboard_time3.get_keyboard()


days4 = sorted(set(days[3])) 
keyboard_time4 = VkKeyboard()
for i in range(len(days4)):
  if (i+1) %3 != 0:
    keyboard_time4.add_button(days4[i], color = VkKeyboardColor.SECONDARY)
  else:
    keyboard_time4.add_line()
    keyboard_time4.add_button(days4[i], color = VkKeyboardColor.SECONDARY)

keyboard_time4.add_line()
keyboard_time4.add_button('Назад', color = VkKeyboardColor.NEGATIVE)
keyboard_time4.get_keyboard()


days5 = sorted(set(days[4])) 
keyboard_time5 = VkKeyboard()
for i in range(len(days5)):
  if (i+1) %3 != 0:
    keyboard_time5.add_button(days5[i], color = VkKeyboardColor.SECONDARY)
  else:
    keyboard_time5.add_line()
    keyboard_time5.add_button(days5[i], color = VkKeyboardColor.SECONDARY)

keyboard_time5.add_line()
keyboard_time5.add_button('Назад', color = VkKeyboardColor.NEGATIVE)
keyboard_time5.get_keyboard()


days6 = sorted(set(days[5])) 
keyboard_time6 = VkKeyboard()
for i in range(len(days6)):
  if (i+1) %3 != 0:
    keyboard_time6.add_button(days6[i], color = VkKeyboardColor.SECONDARY)
  else:
    keyboard_time6.add_line()
    keyboard_time6.add_button(days6[i], color = VkKeyboardColor.SECONDARY)

keyboard_time6.add_line()
keyboard_time6.add_button('Назад', color = VkKeyboardColor.NEGATIVE)
keyboard_time6.get_keyboard()

days7 = sorted(set(days[6])) 
keyboard_time7 = VkKeyboard()
for i in range(len(days7)):
  if (i+1) %3 != 0:
    keyboard_time7.add_button(days7[i], color = VkKeyboardColor.SECONDARY)
  else:
    keyboard_time7.add_line()
    keyboard_time7.add_button(days7[i], color = VkKeyboardColor.SECONDARY)

keyboard_time7.add_line()
keyboard_time7.add_button('Назад', color = VkKeyboardColor.NEGATIVE)
keyboard_time7.get_keyboard()



days8 = sorted(set(days[7])) 
keyboard_time8 = VkKeyboard()
for i in range(len(days8)):
  if (i+1) %3 != 0:
    keyboard_time8.add_button(days8[i], color = VkKeyboardColor.SECONDARY)
  else:
    keyboard_time8.add_line()
    keyboard_time8.add_button(days8[i], color = VkKeyboardColor.SECONDARY)

keyboard_time8.add_line()
keyboard_time8.add_button('Назад', color = VkKeyboardColor.NEGATIVE)
keyboard_time8.get_keyboard()



def create_data_list():    # извлечение содержимого файла в список
    data_file = open('data.txt', encoding = 'utf-8')
    data_list = []       
    for i in data_file:
        data_list.append(i.replace('\n', ''))
    data_file.close()
    return data_list

def writing_file(data_list):    # перезапись файла, иземение инфы
    with open ('data.txt', 'w') as write_file:    # перезаписываем файл
        for i in data_list:
            write_file.write(i+'\n')
    write_file.close()


def google_sheets_append():
    data_file = open('data.txt', encoding = 'utf-8')
    for i in data_file:
        if i.count(';') == 4 and len(i.strip()) >  len(str(user_id)) and int(i[:len(str(user_id))]) == user_id :   # если уже записывался (то есть время и дата в строке уже
            time = i[i.rfind(';') + 2:]     # время на которое записался чел
            fldt = i[i.find(';')+2 :]   # фамилия имя дата время
            ldt = fldt[fldt.find(';')+2:]  # имя дата время
            dt_ = ldt[ldt.find(';')+2:]   # дата время
            date = dt_[dt_.rfind(';')-4:dt_.rfind(';')]   # дата записи
            user_name = (' '.join(i.split('; ')[1:3]))   # фамилия имя
            worksheet = sh.worksheet(date)    # рабочий лист
            values_list = worksheet.col_values(1)   # 1 столбей все значения
            cell = worksheet.find(time.strip())   # ищем нужное время в столбце по строкам
            row_number = cell.row     # номер строки, в которую нужно вписать фи
            col_number = cell.col + 1 # столбец в который надо вписать
            if worksheet.cell(row_number, col_number).value is None:
                worksheet.update_cell(row_number, col_number, user_name)   # запись в ячейку фамилии и имени
            else:
                user_last = worksheet.cell(row_number, col_number).value   # тот кто уже записан на это время
                worksheet.update_cell(row_number, col_number, user_last+'; ' + user_name)   # + новый
    data_file.close()



@application.route("/", methods = ["POST"])
def main():
    try:
        data = json.loads(request.data)
        if data["type"] == "confirmation":
            return "51232427"

        elif data["type"] == "message_new":
            object = data["object"]["message"]
            id = object["peer_id"]
            body = object["text"]
            from_id = str(object['from_id'])
            date = object["date"]
            msg_id = object["id"]
            
            keyboard.get_keyboard()

            if int(str(dt.datetime.now() + dt.timedelta(hours = 3) - dt.datetime.utcfromtimestamp(date))[-9:-7]) > 10:
                    return "ok"
            if body.lower() == "!инфа":
                vk.method("messages.send", {"peer_id": id, "message": id, "random_id": random.randint(2, 2147483647)})


            data_file = open('data.txt', encoding = 'utf-8')

            global list_id    
            list_id = [427492988, 307662820, 165065914, 151614749, 227806857, 345877677, 350545571, 268104063, 339217148, 392163089, 653148781, 285296993, 195770999, 224581774, 447360813, 156613461, 244717553, 235655257, 465106990, 302805904, 287300115, 469244570, 175868920, 147279703, 179144683, 409762091, 225839682, 327669640, 241091828, 198832730, 385197613, 418062886, 122156485, 573985826, 226221881, 342200660, 240186392, 212704874, 350690362, 150154307, 550155457, 446749112, 403573274, 291480047, 333914563, 268900293, 118319908, 270203210, 474176746, 222794723, 208792000, 269313669, 306147459, 549690457, 94530099, 188376334, 338268058, 216650184, 143828585, 392198807, 367821132, 134214255, 223344317, 168256156, 274213537, 299526837, 453197141, 536187198, 604605751, 258857001, 333111286, 257158021, 379480286, 280486098, 317993917, 176293091, 281084411, 458862684, 167586997, 229174955, 308402874, 187901914, 257942284, 487815571, 367586500, 257920183, 421089493, 161764509, 347982254, 223787157, 383247990, 653563461, 265390396, 167789915, 117518236, 304975482, 543058249, 150180203, 303655222, 310720246, 297931315, 185291872, 378562240, 275364958, 502039917, 220108037, 367962239, 650302825, 238554512, 222134674, 231106784, 553477972, 212385786, 222460603, 250463059, 192406554, 303865009, 135334175, 374587903, 178178317, 502915297, 255862773, 289596824, 265696832, 179797135, 638944600, 516575966, 485647926, 500480821, 212925930, 358632029, 328452802, 153020826, 395757188, 272743796, 265659001, 211688127, 520868215, 176475364, 292559474, 410303597, 332885860, 50341212, 565904289, 219038007, 274834223, 335724622, 153635417, 277142643, 740554721, 346388691, 202834258, 352431386, 268620755, 258834169, 378431852, 532353724, 488823322, 255370830, 307624599, 394224616, 613019494, 374289892, 277967890, 220363011, 395083976, 276798219, 345633195, 201681663, 469919469, 271045419, 507654839, 184037932, 536567178, 246312297, 203050174, 242786694, 354744457, 145094001, 611883799, 383605113, 417440527, 91488012, 226008933, 654965266, 181695736, 358870129, 280176290, 231867767, 445501906, 278246538, 350291816, 442433212, 209623422, 171264104, 111494984, 430819277, 229102788, 346478402, 37340573, 189016299, 428502550, 283384375, 590740397, 333157293, 315460591, 497750770, 187596798, 450878154, 100762931, 351859388, 259427275, 63791647, 380841047, 372153029, 163480436, 340632602, 417803775, 668733721, 668733721, 210614278, 152802269, 279705477, 572556244]
            global user_id
            user_id = vk.method("users.get", {"user_ids": id})[0]['id']   # id пользователя
            
            
            if user_id in list_id:    # только для айдишников из анкеты доступна запись на собес
              
                keyboard.get_keyboard()
    
                if body.lower() == 'собеседование':
                    vk.method("messages.send", {"peer_id": id, "message": "Выбери действие", "random_id": random.randint(2, 2147483647), "keyboard": keyboard.get_keyboard()})
    

                if body.lower() == 'записаться на собеседование':
                    user_id = vk.method("users.get", {"user_ids": id})[0]['id']   # id пользователя
                    data_file = open('data.txt', encoding = 'utf-8')
                    for i in data_file:
                        if len(i.strip()) == len(str(user_id)) and int(i) == user_id:    #находим нужного пользователя, который еще не записался (strip убирает пробелы в строке)
                            vk.method("messages.send", {"peer_id": id, "message": "Выбери дату собеседования", "random_id": random.randint(2, 2147483647), "keyboard": keyboard_date.get_keyboard()})  
                        
                        elif i.count(';') == 4 and len(i.strip()) >  len(str(user_id)) and int(i[:len(str(user_id))]) == user_id :   # если уже записывался (то есть время и дата в строке уже
                            fldt = i[i.find(';')+2 :]   # фамилия имя дата время
                            ldt = fldt[fldt.find(';')+2:]  # имя дата время
                            dt_ = ldt[ldt.find(';')+2:]   # дата время
                            message ='Вы уже записаны на ' + dt_
                            vk.method("messages.send", {"peer_id": id, "message": message, "random_id": random.randint(2, 2147483647), "keyboard": keyboard.get_keyboard()})  
                            break
                    data_file.close()




                if body.lower() == 'вернуться назад':
                    vk.method("messages.send", {"peer_id": id, "message": "Выбери действие", "random_id": random.randint(2, 2147483647), "keyboard": keyboard.get_keyboard()})
                if body.lower() == 'назад':
                    data_list = create_data_list()             
                    for i in range(len(data_list)):
                        if len(data_list[i]) > len(str(user_id)) and int(data_list[i][:len(str(user_id))])  == user_id:     # если напротив нужного айди уже вписана дата имя и фамилия
                            data_list[i] = str(user_id)      # удаляем запись даты, оставляем только айди
                            
                        elif len(data_list[i]) == len(str(user_id)) and int(data_list[i]) == user_id:    # если дата еще не выбрана
                            data_list[i] = data_list[i]

                    writing_file(data_list)
                    vk.method("messages.send", {"peer_id": id, "message": "Выбери дату собеседования", "random_id": random.randint(2, 2147483647), "keyboard": keyboard_date.get_keyboard()})
              
                if body.lower() == 'отменить запись':
                    data_list = create_data_list()    
                    for i in range(len(data_list)):
                        if len(data_list[i]) > len(str(user_id)) and int(data_list[i][:len(str(user_id))])  == user_id:     # если напротив нужного айди уже вписана дата имя и фамилия
                            message = 'Отмена записи:' + data_list[i]
              
                            time = data_list[i][data_list[i].rfind(';') + 2:]     # время на которое записался чел
                            fldt = (data_list[i])[data_list[i].find(';')+2 :]   # фамилия имя дата время
                            ldt = fldt[fldt.find(';')+2:]  # имя дата время
                            dt_ = ldt[ldt.find(';')+2:]   # дата время
                            date = dt_[dt_.rfind(';')-4:dt_.rfind(';')]   # дата записи
                            
                            user_name = (' '.join(data_list[i].split('; ')[1:3]))   # фамилия имя

                            data_list[i] = str(user_id)      # удаляем запись даты и времени, оставляем только айди
                            slots[date].append(time)   # возвращаем слот обратно

                            vk.method("messages.send", {"peer_id": id, "message": "Твоя запись успешно отменена", "random_id": random.randint(2, 2147483647), "keyboard": keyboard.get_keyboard()})
                            vk.method("messages.send", {"peer_id": 668733721, "message": message, "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                            vk.method("messages.send", {"peer_id": 668733721, "message": f'Оставшиеся слоты: {slots}', "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека


                            worksheet = sh.worksheet(date)    # рабочий лист
                            values_list = worksheet.col_values(1)   # 1 столбец все значения
                            cell = worksheet.find(time.strip())   # ищем нужное время в столбце по строкам
                            row_number = cell.row     # номер строки, из которой нужно удалить
                            col_number = cell.col + 1 # столбец из которого надо удалить
                            if worksheet.cell(row_number, col_number).value != '':   # в ячейку уже записались
                                user_last =  (worksheet.cell(row_number, col_number).value).split('; ')
                                print(user_last)
                                if user_name.strip() in user_last:
                                    user_last.remove(user_name)
                                user_last = '; '.join(user_last)
                                worksheet.update_cell(row_number, col_number, user_last)   # запись в ячейку фамилии и имени

                            
                            # break
                        elif len(data_list[i]) == len(str(user_id)) and int(data_list[i]) == user_id:    # если дата еще не выбрана
                            data_list[i] = data_list[i]
                            vk.method("messages.send", {"peer_id": id, "message": "Ты ещё не записался", "random_id": random.randint(2, 2147483647), "keyboard": keyboard.get_keyboard()})
                            # break
                    writing_file(data_list)



          
                global user
                if body.lower() == '1.03':
                    if len(slots['1.03']) != 0:   # если на эту дату еще есть слоты
                        data_list = create_data_list()   

                        user = vk.method("users.get", {"user_ids": id})
                        for i in range(len(data_list)):
                            if len(data_list[i].strip()) == len(str(user_id)) and int(data_list[i]) == user_id:
                              data_list[i] = str(user_id) + '; ' + user[0]['first_name'] + '; ' + user[0]['last_name'] + '; ' + str(body) + '; '    # добавляем рядом с нужным айди имя фамилию и дату
             
                        writing_file(data_list)
                        vk.method("messages.send", {"peer_id": id, "message": "Выбери время собеседования", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_time1.get_keyboard()})   
                    else:
                        vk.method("messages.send", {"peer_id": id, "message": "На этот день свободных слотов не осталось, выбери другую дату", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_date.get_keyboard()})   
                  

                if body.lower() == '2.03':
                    if len(slots['2.03']) != 0:   # если на эту дату еще есть слоты
                        data_list = create_data_list()

                        user = vk.method("users.get", {"user_ids": id})
                        for i in range(len(data_list)):
                            if len(data_list[i].strip()) == len(str(user_id)) and int(data_list[i]) == user_id:
                              data_list[i] = str(user_id) + '; ' + user[0]['first_name'] + '; ' + user[0]['last_name'] + '; ' + str(body) + '; '    # добавляем рядом с нужным айди имя фамилию и дату
             
                        writing_file(data_list)
                        vk.method("messages.send", {"peer_id": id, "message": "Выбери время собеседования", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_time2.get_keyboard()})   
                    else:
                        vk.method("messages.send", {"peer_id": id, "message": "На этот день свободных слотов не осталось, выбери другую дату", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_date.get_keyboard()})   

                if body.lower() == '3.03':
                    if len(slots['3.03']) != 0:   # если на эту дату еще есть слоты
                        data_list = create_data_list()


                        user = vk.method("users.get", {"user_ids": id})
                        for i in range(len(data_list)):
                            if len(data_list[i].strip()) == len(str(user_id)) and int(data_list[i]) == user_id:
                              data_list[i] = str(user_id) + '; ' + user[0]['first_name'] + '; ' + user[0]['last_name'] + '; ' + str(body) + '; '    # добавляем рядом с нужным айди имя фамилию и дату
             
                        writing_file(data_list)
                        vk.method("messages.send", {"peer_id": id, "message": "Выбери время собеседования", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_time3.get_keyboard()})   
                    else:
                        vk.method("messages.send", {"peer_id": id, "message": "На этот день свободных слотов не осталось, выбери другую дату", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_date.get_keyboard()})   

                if body.lower() == '4.03':
                    if len(slots['4.03']) != 0:   # если на эту дату еще есть слоты
                        data_list = create_data_list()

                        user = vk.method("users.get", {"user_ids": id})
                        for i in range(len(data_list)):
                            if len(data_list[i].strip()) == len(str(user_id)) and int(data_list[i]) == user_id:
                              data_list[i] = str(user_id) + '; ' + user[0]['first_name'] + '; ' + user[0]['last_name'] + '; ' + str(body) + '; '    # добавляем рядом с нужным айди имя фамилию и дату
             
                        writing_file(data_list)
                        vk.method("messages.send", {"peer_id": id, "message": "Выбери время собеседования", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_time4.get_keyboard()})   
                    else:
                        vk.method("messages.send", {"peer_id": id, "message": "На этот день свободных слотов не осталось, выбери другую дату", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_date.get_keyboard()})   
                
                
                if body.lower() == '5.03':
                    if len(slots['5.03']) != 0:   # если на эту дату еще есть слоты
                        data_list = create_data_list()


                        user = vk.method("users.get", {"user_ids": id})
                        for i in range(len(data_list)):
                            if len(data_list[i].strip()) == len(str(user_id)) and int(data_list[i]) == user_id:
                              data_list[i] = str(user_id) + '; ' + user[0]['first_name'] + '; ' + user[0]['last_name'] + '; ' + str(body) + '; '    # добавляем рядом с нужным айди имя фамилию и дату
             
                        writing_file(data_list)
                        vk.method("messages.send", {"peer_id": id, "message": "Выбери время собеседования", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_time5.get_keyboard()})   
                    else:
                        vk.method("messages.send", {"peer_id": id, "message": "На этот день свободных слотов не осталось, выбери другую дату", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_date.get_keyboard()})   
                
                
                if body.lower() == '6.03':
                    if len(slots['6.03']) != 0:   # если на эту дату еще есть слоты
                        data_list = create_data_list()


                        user = vk.method("users.get", {"user_ids": id})
                        for i in range(len(data_list)):
                            if len(data_list[i].strip()) == len(str(user_id)) and int(data_list[i]) == user_id:
                              data_list[i] = str(user_id) + '; ' + user[0]['first_name'] + '; ' + user[0]['last_name'] + '; ' + str(body) + '; '    # добавляем рядом с нужным айди имя фамилию и дату
             
                        writing_file(data_list)
                        vk.method("messages.send", {"peer_id": id, "message": "Выбери время собеседования", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_time6.get_keyboard()})   
                    else:
                        vk.method("messages.send", {"peer_id": id, "message": "На этот день свободных слотов не осталось, выбери другую дату", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_date.get_keyboard()})   
                
                
                if body.lower() == '7.03':
                    if len(slots['7.03']) != 0:   # если на эту дату еще есть слоты
                        data_list = create_data_list()


                        user = vk.method("users.get", {"user_ids": id})
                        for i in range(len(data_list)):
                            if len(data_list[i].strip()) == len(str(user_id)) and int(data_list[i]) == user_id:
                              data_list[i] = str(user_id) + '; ' + user[0]['first_name'] + '; ' + user[0]['last_name'] + '; ' + str(body) + '; '    # добавляем рядом с нужным айди имя фамилию и дату
             
                        writing_file(data_list)
                        vk.method("messages.send", {"peer_id": id, "message": "Выбери время собеседования", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_time7.get_keyboard()})   
                    else:
                        vk.method("messages.send", {"peer_id": id, "message": "На этот день свободных слотов не осталось, выбери другую дату", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_date.get_keyboard()})   
                
                
                if body.lower() == '8.03':
                    if len(slots['8.03']) != 0:   # если на эту дату еще есть слоты
                        data_list = create_data_list()  


                        user = vk.method("users.get", {"user_ids": id})
                        for i in range(len(data_list)):
                            if len(data_list[i].strip()) == len(str(user_id)) and int(data_list[i]) == user_id:
                              data_list[i] = str(user_id) + '; ' + user[0]['first_name'] + '; ' + user[0]['last_name'] + '; ' + str(body) + '; '    # добавляем рядом с нужным айди имя фамилию и дату
             
                        writing_file(data_list)
                        vk.method("messages.send", {"peer_id": id, "message": "Выбери время собеседования", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_time8.get_keyboard()})   
                    else:
                        vk.method("messages.send", {"peer_id": id, "message": "На этот день свободных слотов не осталось, выбери другую дату", "random_id": random.randint(2, 2147483647) , "keyboard": keyboard_date.get_keyboard()})   


                if body in slots['1.03'] or body in slots['2.03'] or body in slots['3.03'] or body in slots['4.03'] or body in slots['5.03'] or body in slots['6.03'] or body in slots['7.03'] or body in slots['8.03']:
                    data_list = create_data_list() 


                    for i in range(len(data_list)):
                        if len(data_list[i]) > len(str(user_id)) and int(data_list[i][:len(str(user_id))])  == user_id:     # если напротив нужного айди уже вписана дата имя и фамилия
                            date = data_list[i][data_list[i].rfind(';')-4: data_list[i].rfind(';')]    # дата на которую уже записался чел
                            

                            if date == '1.03':
                                if body in slots['1.03']:   # 1 день
                                    data_list[i] += str(body)  # добавляем рядом с нужным айди имя фамилию и дату
                                    slots[date].remove(body)   # удаляем слот, на который записались           
                                    writing_file(data_list)
                                    message = 'Вы записаны на ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": id, "message": message, "random_id": random.randint(1, 2147483647), "keyboard": keyboard.get_keyboard()})
                                    fl = ('; '.join(data_list[i].split('; ')[1:3]))   # фамилия имя
                                    message = str(user_id) + '; ' +  fl + '; ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": 668733721, "message": message, "random_id": random.randint(1, 2147483647)})   # переселыка в лc о записи человека
                                    vk.method("messages.send", {"peer_id": 668733721, "message": f'Оставшиеся слоты: {slots}', "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                            
                                else:
                                    vk.method("messages.send", {"peer_id": id, "message": "Это время уже занято, выберите другое", "random_id": random.randint(1, 2147483647), "keyboard": keyboard_time1.get_keyboard()})


                            if date == '2.03':
                                if body in slots['2.03']:   # 2 день
                                    data_list[i] += str(body)  # добавляем рядом с нужным айди имя фамилию и дату
                                    slots[date].remove(body)   # удаляем слот, на который записались           
                                    writing_file(data_list)
                                    message = 'Вы записаны на ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": id, "message": message, "random_id": random.randint(1, 2147483647), "keyboard": keyboard.get_keyboard()})
                                    fl = ('; '.join(data_list[i].split('; ')[1:3]))   # фамилия имя
                                    message = str(user_id) + '; ' +  fl + '; ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": 668733721, "message": message, "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                                    vk.method("messages.send", {"peer_id": 668733721, "message": f'Оставшиеся слоты: {slots}', "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                            
                                else:
                                    vk.method("messages.send", {"peer_id": id, "message": "Это время уже занято, выберите другое", "random_id": random.randint(1, 2147483647), "keyboard": keyboard_time2.get_keyboard()})



                            if date == '3.03':
                                if body in slots['3.03']:   # 3 день
                                    data_list[i] += str(body)  # добавляем рядом с нужным айди имя фамилию и дату
                                    slots[date].remove(body)   # удаляем слот, на который записались           
                                    writing_file(data_list)
                                    message = 'Вы записаны на ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": id, "message": message, "random_id": random.randint(1, 2147483647), "keyboard": keyboard.get_keyboard()})
                                    fl = ('; '.join(data_list[i].split('; ')[1:3]))   # фамилия имя
                                    message = str(user_id) + '; ' +  fl + '; ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": 668733721, "message": message, "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                                    vk.method("messages.send", {"peer_id": 668733721, "message": f'Оставшиеся слоты: {slots}', "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                            
                                else:
                                    vk.method("messages.send", {"peer_id": id, "message": "Это время уже занято, выберите другое", "random_id": random.randint(1, 2147483647), "keyboard": keyboard_time3.get_keyboard()})

                                        
                            if date == '4.03':
                                if body in slots['4.03']:   # 4 день
                                    data_list[i] += str(body)  # добавляем рядом с нужным айди имя фамилию и дату
                                    slots[date].remove(body)   # удаляем слот, на который записались           
                                    writing_file(data_list)
                                    message = 'Вы записаны на ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": id, "message": message, "random_id": random.randint(1, 2147483647), "keyboard": keyboard.get_keyboard()})
                                    fl = ('; '.join(data_list[i].split('; ')[1:3]))   # фамилия имя
                                    message = str(user_id) + '; ' +  fl + '; ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": 668733721, "message": message, "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                                    vk.method("messages.send", {"peer_id": 668733721, "message": f'Оставшиеся слоты: {slots}', "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                            
                                else:
                                    vk.method("messages.send", {"peer_id": id, "message": "Это время уже занято, выберите другое", "random_id": random.randint(1, 2147483647), "keyboard": keyboard_time4.get_keyboard()})

                                        
                            if date == '5.03':
                                if body in slots['5.03']:   # 5 день
                                    data_list[i] += str(body)  # добавляем рядом с нужным айди имя фамилию и дату
                                    slots[date].remove(body)   # удаляем слот, на который записались           
                                    writing_file(data_list)
                                    message = 'Вы записаны на ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": id, "message": message, "random_id": random.randint(1, 2147483647), "keyboard": keyboard.get_keyboard()})
                                    fl = ('; '.join(data_list[i].split('; ')[1:3]))   # фамилия имя
                                    message = str(user_id) + '; ' +  fl + '; ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": 668733721, "message": message, "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                                    vk.method("messages.send", {"peer_id": 668733721, "message": f'Оставшиеся слоты: {slots}', "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                            
                                else:
                                    vk.method("messages.send", {"peer_id": id, "message": "Это время уже занято, выберите другое", "random_id": random.randint(1, 2147483647), "keyboard": keyboard_time5.get_keyboard()})

                                        
                            if date == '6.03':
                                if body in slots['6.03']:   # 6 день
                                    data_list[i] += str(body)  # добавляем рядом с нужным айди имя фамилию и дату
                                    slots[date].remove(body)   # удаляем слот, на который записались           
                                    writing_file(data_list)
                                    message = 'Вы записаны на ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": id, "message": message, "random_id": random.randint(1, 2147483647), "keyboard": keyboard.get_keyboard()})
                                    fl = ('; '.join(data_list[i].split('; ')[1:3]))   # фамилия имя
                                    message = str(user_id) + '; ' +  fl + '; ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": 668733721, "message": message, "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                                    vk.method("messages.send", {"peer_id": 668733721, "message": f'Оставшиеся слоты: {slots}', "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                            
                                else:
                                    vk.method("messages.send", {"peer_id": id, "message": "Это время уже занято, выберите другое", "random_id": random.randint(1, 2147483647), "keyboard": keyboard_time6.get_keyboard()})

                                        
                            if date == '7.03':
                                if body in slots['7.03']:   # 7 день
                                    data_list[i] += str(body)  # добавляем рядом с нужным айди имя фамилию и дату
                                    slots[date].remove(body)   # удаляем слот, на который записались           
                                    writing_file(data_list)
                                    message = 'Вы записаны на ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": id, "message": message, "random_id": random.randint(1, 2147483647), "keyboard": keyboard.get_keyboard()})
                                    fl = ('; '.join(data_list[i].split('; ')[1:3]))   # фамилия имя
                                    message = str(user_id) + '; ' +  fl + '; ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": 668733721, "message": message, "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                                    vk.method("messages.send", {"peer_id": 668733721, "message": f'Оставшиеся слоты: {slots}', "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                            
                                else:
                                    vk.method("messages.send", {"peer_id": id, "message": "Это время уже занято, выберите другое", "random_id": random.randint(1, 2147483647), "keyboard": keyboard_time7.get_keyboard()})

                                        
                            if date == '8.03':
                                if body in slots['8.03']:   # 8 день
                                    data_list[i] += str(body)  # добавляем рядом с нужным айди имя фамилию и дату
                                    slots[date].remove(body)   # удаляем слот, на который записались           
                                    writing_file(data_list)
                                    message = 'Вы записаны на ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": id, "message": message, "random_id": random.randint(1, 2147483647), "keyboard": keyboard.get_keyboard()})
                                    fl = ('; '.join(data_list[i].split('; ')[1:3]))   # фамилия имя
                                    message = str(user_id) + '; ' +  fl + '; ' + str(date) + '; ' + str(body)
                                    vk.method("messages.send", {"peer_id": 668733721, "message": message, "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                                    vk.method("messages.send", {"peer_id": 668733721, "message": f'Оставшиеся слоты: {slots}', "random_id": random.randint(1, 2147483647)})   # переселыка в лм о записи человека
                            
                                else:
                                    vk.method("messages.send", {"peer_id": id, "message": "Это время уже занято, выберите другое", "random_id": random.randint(1, 2147483647), "keyboard": keyboard_time8.get_keyboard()})
                    
                    google_sheets_append()
                                                                                                            
                                    # else:
            #     vk.method("messages.send", {"peer_id": id, "message": 'Ты не можешь записаться', "random_id": random.randint(1, 2147483647)})

    except:
            vk.method("messages.send", {"peer_id": (668733721), "message": traceback.format_exc(), "random_id": random.randint(1, 2147483647)})
            vk.method("messages.send", {"peer_id": (572556244), "message": traceback.format_exc(), "random_id": random.randint(1, 2147483647)})

    return "ok"

if __name__ == "__main__":
   application.run(host='0.0.0.0')
